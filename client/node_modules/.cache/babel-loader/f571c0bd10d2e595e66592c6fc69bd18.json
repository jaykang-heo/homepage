{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst graphql_tools_1 = require(\"graphql-tools\");\n\nconst graphql_1 = require(\"graphql\");\n\nconst apollo_server_caching_1 = require(\"apollo-server-caching\");\n\nconst runtimeSupportsUploads_1 = __importDefault(require(\"./utils/runtimeSupportsUploads\"));\n\nconst apollo_server_errors_1 = require(\"apollo-server-errors\");\n\nconst index_1 = require(\"./index\");\n\nconst playground_1 = require(\"./playground\");\n\nconst schemaHash_1 = require(\"./utils/schemaHash\");\n\nconst isDirectiveDefined_1 = require(\"./utils/isDirectiveDefined\");\n\nconst createSHA_1 = __importDefault(require(\"./utils/createSHA\"));\n\nconst requestPipeline_1 = require(\"./requestPipeline\");\n\nconst apollo_server_env_1 = require(\"apollo-server-env\");\n\nconst apollo_tools_1 = require(\"@apollographql/apollo-tools\");\n\nconst NoIntrospection = context => ({\n  Field(node) {\n    if (node.name.value === '__schema' || node.name.value === '__type') {\n      context.reportError(new graphql_1.GraphQLError('GraphQL introspection is not allowed by Apollo Server, but the query contained __schema or __type. To enable introspection, pass introspection: true to ApolloServer in production', [node]));\n    }\n  }\n\n});\n\nfunction getEngineApiKey(engine) {\n  const keyFromEnv = process.env.ENGINE_API_KEY || '';\n\n  if (engine === false) {\n    return;\n  } else if (typeof engine === 'object' && engine.apiKey) {\n    return engine.apiKey;\n  } else if (keyFromEnv) {\n    return keyFromEnv;\n  }\n\n  return;\n}\n\nfunction getEngineGraphVariant(engine) {\n  if (engine === false) {\n    return;\n  } else if (typeof engine === 'object' && engine.schemaTag) {\n    return engine.schemaTag;\n  } else {\n    return process.env.ENGINE_SCHEMA_TAG;\n  }\n}\n\nfunction getEngineServiceId(engine) {\n  const engineApiKey = getEngineApiKey(engine);\n\n  if (engineApiKey) {\n    return engineApiKey.split(':', 2)[1];\n  }\n\n  return;\n}\n\nconst forbidUploadsForTesting = process && process.env.NODE_ENV === 'test' && !runtimeSupportsUploads_1.default;\n\nfunction approximateObjectSize(obj) {\n  return Buffer.byteLength(JSON.stringify(obj), 'utf8');\n}\n\nclass ApolloServerBase {\n  constructor(config) {\n    this.graphqlPath = '/graphql';\n    this.requestOptions = Object.create(null);\n    this.plugins = [];\n    this.toDispose = new Set();\n    if (!config) throw new Error('ApolloServer requires options.');\n    this.config = config;\n\n    const {\n      context,\n      resolvers,\n      schema,\n      schemaDirectives,\n      modules,\n      typeDefs,\n      parseOptions = {},\n      introspection,\n      mocks,\n      mockEntireSchema,\n      extensions,\n      engine,\n      subscriptions,\n      uploads,\n      playground,\n      plugins,\n      gateway,\n      experimental_approximateDocumentStoreMiB\n    } = config,\n          requestOptions = __rest(config, [\"context\", \"resolvers\", \"schema\", \"schemaDirectives\", \"modules\", \"typeDefs\", \"parseOptions\", \"introspection\", \"mocks\", \"mockEntireSchema\", \"extensions\", \"engine\", \"subscriptions\", \"uploads\", \"playground\", \"plugins\", \"gateway\", \"experimental_approximateDocumentStoreMiB\"]);\n\n    if (gateway && (modules || schema || typeDefs || resolvers)) {\n      throw new Error('Cannot define both `gateway` and any of: `modules`, `schema`, `typeDefs`, or `resolvers`');\n    }\n\n    this.parseOptions = parseOptions;\n    this.context = context;\n    this.ensurePluginInstantiation(plugins);\n    const isDev = process.env.NODE_ENV !== 'production';\n\n    if (typeof introspection === 'boolean' && !introspection || introspection === undefined && !isDev) {\n      const noIntro = [NoIntrospection];\n      requestOptions.validationRules = requestOptions.validationRules ? requestOptions.validationRules.concat(noIntro) : noIntro;\n    }\n\n    if (requestOptions.cacheControl !== false) {\n      if (typeof requestOptions.cacheControl === 'boolean' && requestOptions.cacheControl === true) {\n        requestOptions.cacheControl = {\n          stripFormattedExtensions: false,\n          calculateHttpHeaders: false,\n          defaultMaxAge: 0\n        };\n      } else {\n        requestOptions.cacheControl = Object.assign({\n          stripFormattedExtensions: true,\n          calculateHttpHeaders: true,\n          defaultMaxAge: 0\n        }, requestOptions.cacheControl);\n      }\n    }\n\n    if (!requestOptions.cache) {\n      requestOptions.cache = new apollo_server_caching_1.InMemoryLRUCache();\n    }\n\n    if (requestOptions.persistedQueries !== false) {\n      const _a = requestOptions.persistedQueries || Object.create(null),\n            {\n        cache: apqCache = requestOptions.cache\n      } = _a,\n            apqOtherOptions = __rest(_a, [\"cache\"]);\n\n      requestOptions.persistedQueries = Object.assign({\n        cache: new apollo_server_caching_1.PrefixingKeyValueCache(apqCache, requestPipeline_1.APQ_CACHE_PREFIX)\n      }, apqOtherOptions);\n    } else {\n      delete requestOptions.persistedQueries;\n    }\n\n    this.requestOptions = requestOptions;\n\n    if (uploads !== false && !forbidUploadsForTesting) {\n      if (this.supportsUploads()) {\n        if (!runtimeSupportsUploads_1.default) {\n          printNodeFileUploadsMessage();\n          throw new Error('`graphql-upload` is no longer supported on Node.js < v8.5.0.  ' + 'See https://bit.ly/gql-upload-node-6.');\n        }\n\n        if (uploads === true || typeof uploads === 'undefined') {\n          this.uploadsConfig = {};\n        } else {\n          this.uploadsConfig = uploads;\n        }\n      } else if (uploads) {\n        throw new Error('This implementation of ApolloServer does not support file uploads because the environment cannot accept multi-part forms');\n      }\n    }\n\n    if (engine && typeof engine === 'object') {\n      if (engine.maskErrorDetails && engine.rewriteError) {\n        throw new Error(\"Can't set both maskErrorDetails and rewriteError!\");\n      } else if (engine.rewriteError && typeof engine.rewriteError !== 'function') {\n        throw new Error('rewriteError must be a function');\n      } else if (engine.maskErrorDetails) {\n        engine.rewriteError = () => new graphql_1.GraphQLError('<masked>');\n\n        delete engine.maskErrorDetails;\n      }\n    }\n\n    this.engineServiceId = getEngineServiceId(engine);\n    const apiKey = getEngineApiKey(engine);\n\n    if (apiKey) {\n      this.engineApiKeyHash = createSHA_1.default('sha512').update(apiKey).digest('hex');\n    }\n\n    if (this.engineServiceId) {\n      const {\n        EngineReportingAgent\n      } = require('apollo-engine-reporting');\n\n      this.engineReportingAgent = new EngineReportingAgent(typeof engine === 'object' ? engine : Object.create(null));\n    }\n\n    if (gateway && subscriptions !== false) {\n      throw new Error(['Subscriptions are not yet compatible with the gateway.', \"Set `subscriptions: false` in Apollo Server's constructor to\", 'explicitly disable subscriptions (which are on by default)', 'and allow for gateway functionality.'].join(' '));\n    } else if (subscriptions !== false) {\n      if (this.supportsSubscriptions()) {\n        if (subscriptions === true || typeof subscriptions === 'undefined') {\n          this.subscriptionServerOptions = {\n            path: this.graphqlPath\n          };\n        } else if (typeof subscriptions === 'string') {\n          this.subscriptionServerOptions = {\n            path: subscriptions\n          };\n        } else {\n          this.subscriptionServerOptions = Object.assign({\n            path: this.graphqlPath\n          }, subscriptions);\n        }\n\n        this.subscriptionsPath = this.subscriptionServerOptions.path;\n      } else if (subscriptions) {\n        throw new Error('This implementation of ApolloServer does not support GraphQL subscriptions.');\n      }\n    }\n\n    this.playgroundOptions = playground_1.createPlaygroundOptions(playground);\n\n    const _schema = this.initSchema();\n\n    if (graphql_1.isSchema(_schema)) {\n      const derivedData = this.generateSchemaDerivedData(_schema);\n      this.schema = derivedData.schema;\n      this.schemaDerivedData = Promise.resolve(derivedData);\n    } else if (typeof _schema.then === 'function') {\n      this.schemaDerivedData = _schema.then(schema => this.generateSchemaDerivedData(schema));\n    } else {\n      throw new Error(\"Unexpected error: Unable to resolve a valid GraphQLSchema.  Please file an issue with a reproduction of this error, if possible.\");\n    }\n  }\n\n  setGraphQLPath(path) {\n    this.graphqlPath = path;\n  }\n\n  initSchema() {\n    const {\n      gateway,\n      engine,\n      schema,\n      modules,\n      typeDefs,\n      resolvers,\n      schemaDirectives,\n      parseOptions\n    } = this.config;\n\n    if (gateway) {\n      this.toDispose.add(gateway.onSchemaChange(schema => this.schemaDerivedData = Promise.resolve(this.generateSchemaDerivedData(schema))));\n      const graphVariant = getEngineGraphVariant(engine);\n      const engineConfig = this.engineApiKeyHash && this.engineServiceId ? Object.assign({\n        apiKeyHash: this.engineApiKeyHash,\n        graphId: this.engineServiceId\n      }, graphVariant && {\n        graphVariant\n      }) : undefined;\n      return gateway.load({\n        engine: engineConfig\n      }).then(config => {\n        this.requestOptions.executor = config.executor;\n        return config.schema;\n      });\n    }\n\n    let constructedSchema;\n\n    if (schema) {\n      constructedSchema = schema;\n    } else if (modules) {\n      const {\n        schema,\n        errors\n      } = apollo_tools_1.buildServiceDefinition(modules);\n\n      if (errors && errors.length > 0) {\n        throw new Error(errors.map(error => error.message).join('\\n\\n'));\n      }\n\n      constructedSchema = schema;\n    } else {\n      if (!typeDefs) {\n        throw Error('Apollo Server requires either an existing schema, modules or typeDefs');\n      }\n\n      const augmentedTypeDefs = Array.isArray(typeDefs) ? typeDefs : [typeDefs];\n\n      if (!isDirectiveDefined_1.isDirectiveDefined(augmentedTypeDefs, 'cacheControl')) {\n        augmentedTypeDefs.push(index_1.gql`\n            enum CacheControlScope {\n              PUBLIC\n              PRIVATE\n            }\n\n            directive @cacheControl(\n              maxAge: Int\n              scope: CacheControlScope\n            ) on FIELD_DEFINITION | OBJECT | INTERFACE\n          `);\n      }\n\n      if (this.uploadsConfig) {\n        const {\n          GraphQLUpload\n        } = require('graphql-upload');\n\n        if (Array.isArray(resolvers)) {\n          if (resolvers.every(resolver => !resolver.Upload)) {\n            resolvers.push({\n              Upload: GraphQLUpload\n            });\n          }\n        } else {\n          if (resolvers && !resolvers.Upload) {\n            resolvers.Upload = GraphQLUpload;\n          }\n        }\n\n        augmentedTypeDefs.push(index_1.gql`\n            scalar Upload\n          `);\n      }\n\n      constructedSchema = graphql_tools_1.makeExecutableSchema({\n        typeDefs: augmentedTypeDefs,\n        schemaDirectives,\n        resolvers,\n        parseOptions\n      });\n    }\n\n    return constructedSchema;\n  }\n\n  generateSchemaDerivedData(schema) {\n    const schemaHash = schemaHash_1.generateSchemaHash(schema);\n    const {\n      mocks,\n      mockEntireSchema,\n      extensions: _extensions\n    } = this.config;\n\n    if (mocks || typeof mockEntireSchema !== 'undefined' && mocks !== false) {\n      graphql_tools_1.addMockFunctionsToSchema({\n        schema,\n        mocks: typeof mocks === 'boolean' || typeof mocks === 'undefined' ? {} : mocks,\n        preserveResolvers: typeof mockEntireSchema === 'undefined' ? false : !mockEntireSchema\n      });\n    }\n\n    const extensions = [];\n    const schemaIsFederated = this.schemaIsFederated(schema);\n    const {\n      engine\n    } = this.config;\n\n    if (this.engineReportingAgent) {\n      if (schemaIsFederated) {\n        console.warn(\"It looks like you're running a federated schema and you've configured your service \" + 'to report metrics to Apollo Graph Manager. You should only configure your Apollo gateway ' + 'to report metrics to Apollo Graph Manager.');\n      }\n\n      extensions.push(() => this.engineReportingAgent.newExtension(schemaHash));\n    } else if (engine !== false && schemaIsFederated) {\n      const {\n        EngineFederatedTracingExtension\n      } = require('apollo-engine-reporting');\n\n      const rewriteError = engine && typeof engine === 'object' ? engine.rewriteError : undefined;\n      extensions.push(() => new EngineFederatedTracingExtension({\n        rewriteError\n      }));\n    }\n\n    extensions.push(...(_extensions || []));\n    const documentStore = this.initializeDocumentStore();\n    return {\n      schema,\n      schemaHash,\n      extensions,\n      documentStore\n    };\n  }\n\n  willStart() {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, function* () {\n      const {\n        schema,\n        schemaHash\n      } = yield this.schemaDerivedData;\n      const service = {\n        schema: schema,\n        schemaHash: schemaHash,\n        engine: {\n          serviceID: this.engineServiceId,\n          apiKeyHash: this.engineApiKeyHash\n        }\n      };\n\n      if ((_a = this.requestOptions.persistedQueries) === null || _a === void 0 ? void 0 : _a.cache) {\n        service.persistedQueries = {\n          cache: this.requestOptions.persistedQueries.cache\n        };\n      }\n\n      persistedQueries: this.requestOptions.persistedQueries, yield Promise.all(this.plugins.map(plugin => plugin.serverWillStart && plugin.serverWillStart(service)));\n    });\n  }\n\n  stop() {\n    return __awaiter(this, void 0, void 0, function* () {\n      this.toDispose.forEach(dispose => dispose());\n      if (this.subscriptionServer) yield this.subscriptionServer.close();\n\n      if (this.engineReportingAgent) {\n        this.engineReportingAgent.stop();\n        yield this.engineReportingAgent.sendAllReports();\n      }\n    });\n  }\n\n  installSubscriptionHandlers(server) {\n    if (!this.subscriptionServerOptions) {\n      if (this.config.gateway) {\n        throw Error('Subscriptions are not supported when operating as a gateway');\n      }\n\n      if (this.supportsSubscriptions()) {\n        throw Error('Subscriptions are disabled, due to subscriptions set to false in the ApolloServer constructor');\n      } else {\n        throw Error('Subscriptions are not supported, choose an integration, such as apollo-server-express that allows persistent connections');\n      }\n    }\n\n    const {\n      SubscriptionServer\n    } = require('subscriptions-transport-ws');\n\n    const {\n      onDisconnect,\n      onConnect,\n      keepAlive,\n      path\n    } = this.subscriptionServerOptions;\n    const schema = this.schema;\n    if (this.schema === undefined) throw new Error('Schema undefined during creation of subscription server.');\n    this.subscriptionServer = SubscriptionServer.create({\n      schema,\n      execute: graphql_1.execute,\n      subscribe: graphql_1.subscribe,\n      onConnect: onConnect ? onConnect : connectionParams => Object.assign({}, connectionParams),\n      onDisconnect: onDisconnect,\n      onOperation: (message, connection) => __awaiter(this, void 0, void 0, function* () {\n        connection.formatResponse = value => Object.assign(Object.assign({}, value), {\n          errors: value.errors && apollo_server_errors_1.formatApolloErrors([...value.errors], {\n            formatter: this.requestOptions.formatError,\n            debug: this.requestOptions.debug\n          })\n        });\n\n        connection.formatError = this.requestOptions.formatError;\n        let context = this.context ? this.context : {\n          connection\n        };\n\n        try {\n          context = typeof this.context === 'function' ? yield this.context({\n            connection,\n            payload: message.payload\n          }) : context;\n        } catch (e) {\n          throw apollo_server_errors_1.formatApolloErrors([e], {\n            formatter: this.requestOptions.formatError,\n            debug: this.requestOptions.debug\n          })[0];\n        }\n\n        return Object.assign(Object.assign({}, connection), {\n          context\n        });\n      }),\n      keepAlive\n    }, {\n      server,\n      path\n    });\n  }\n\n  supportsSubscriptions() {\n    return false;\n  }\n\n  supportsUploads() {\n    return false;\n  }\n\n  schemaIsFederated(schema) {\n    const serviceType = schema.getType('_Service');\n\n    if (!(serviceType && graphql_1.isObjectType(serviceType))) {\n      return false;\n    }\n\n    const sdlField = serviceType.getFields().sdl;\n\n    if (!sdlField) {\n      return false;\n    }\n\n    const sdlFieldType = sdlField.type;\n\n    if (!graphql_1.isScalarType(sdlFieldType)) {\n      return false;\n    }\n\n    return sdlFieldType.name == 'String';\n  }\n\n  ensurePluginInstantiation(plugins) {\n    if (!plugins || !plugins.length) {\n      return;\n    }\n\n    this.plugins = plugins.map(plugin => {\n      if (typeof plugin === 'function') {\n        return plugin();\n      }\n\n      return plugin;\n    });\n  }\n\n  initializeDocumentStore() {\n    return new apollo_server_caching_1.InMemoryLRUCache({\n      maxSize: Math.pow(2, 20) * (this.experimental_approximateDocumentStoreMiB || 30),\n      sizeCalculator: approximateObjectSize\n    });\n  }\n\n  graphQLServerOptions(integrationContextArgument) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const {\n        schema,\n        documentStore,\n        extensions\n      } = yield this.schemaDerivedData;\n      let context = this.context ? this.context : {};\n\n      try {\n        context = typeof this.context === 'function' ? yield this.context(integrationContextArgument || {}) : context;\n      } catch (error) {\n        context = () => {\n          throw error;\n        };\n      }\n\n      return Object.assign({\n        schema,\n        plugins: this.plugins,\n        documentStore,\n        extensions,\n        context,\n        persistedQueries: this.requestOptions.persistedQueries,\n        fieldResolver: this.requestOptions.fieldResolver,\n        parseOptions: this.parseOptions,\n        reporting: !!this.engineReportingAgent\n      }, this.requestOptions);\n    });\n  }\n\n  executeOperation(request) {\n    return __awaiter(this, void 0, void 0, function* () {\n      let options;\n\n      try {\n        options = yield this.graphQLServerOptions();\n      } catch (e) {\n        e.message = `Invalid options provided to ApolloServer: ${e.message}`;\n        throw new Error(e);\n      }\n\n      if (typeof options.context === 'function') {\n        options.context = options.context();\n      }\n\n      const requestCtx = {\n        request,\n        context: options.context || Object.create(null),\n        cache: options.cache,\n        response: {\n          http: {\n            headers: new apollo_server_env_1.Headers()\n          }\n        }\n      };\n      return requestPipeline_1.processGraphQLRequest(options, requestCtx);\n    });\n  }\n\n}\n\nexports.ApolloServerBase = ApolloServerBase;\n\nfunction printNodeFileUploadsMessage() {\n  console.error(['*****************************************************************', '*                                                               *', '* ERROR! Manual intervention is necessary for Node.js < v8.5.0! *', '*                                                               *', '*****************************************************************', '', 'The third-party `graphql-upload` package, which is used to implement', 'file uploads in Apollo Server 2.x, no longer supports Node.js LTS', 'versions prior to Node.js v8.5.0.', '', 'Deployments which NEED file upload capabilities should update to', 'Node.js >= v8.5.0 to continue using uploads.', '', 'If this server DOES NOT NEED file uploads and wishes to continue', 'using this version of Node.js, uploads can be disabled by adding:', '', '  uploads: false,', '', '...to the options for Apollo Server and re-deploying the server.', '', 'For more information, see https://bit.ly/gql-upload-node-6.', ''].join('\\n'));\n}","map":{"version":3,"sources":["../src/ApolloServer.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __rest = (this && this.__rest) || function (s, e) {\n    var t = {};\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n        t[p] = s[p];\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n                t[p[i]] = s[p[i]];\n        }\n    return t;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst graphql_tools_1 = require(\"graphql-tools\");\nconst graphql_1 = require(\"graphql\");\nconst apollo_server_caching_1 = require(\"apollo-server-caching\");\nconst runtimeSupportsUploads_1 = __importDefault(require(\"./utils/runtimeSupportsUploads\"));\nconst apollo_server_errors_1 = require(\"apollo-server-errors\");\nconst index_1 = require(\"./index\");\nconst playground_1 = require(\"./playground\");\nconst schemaHash_1 = require(\"./utils/schemaHash\");\nconst isDirectiveDefined_1 = require(\"./utils/isDirectiveDefined\");\nconst createSHA_1 = __importDefault(require(\"./utils/createSHA\"));\nconst requestPipeline_1 = require(\"./requestPipeline\");\nconst apollo_server_env_1 = require(\"apollo-server-env\");\nconst apollo_tools_1 = require(\"@apollographql/apollo-tools\");\nconst NoIntrospection = (context) => ({\n    Field(node) {\n        if (node.name.value === '__schema' || node.name.value === '__type') {\n            context.reportError(new graphql_1.GraphQLError('GraphQL introspection is not allowed by Apollo Server, but the query contained __schema or __type. To enable introspection, pass introspection: true to ApolloServer in production', [node]));\n        }\n    },\n});\nfunction getEngineApiKey(engine) {\n    const keyFromEnv = process.env.ENGINE_API_KEY || '';\n    if (engine === false) {\n        return;\n    }\n    else if (typeof engine === 'object' && engine.apiKey) {\n        return engine.apiKey;\n    }\n    else if (keyFromEnv) {\n        return keyFromEnv;\n    }\n    return;\n}\nfunction getEngineGraphVariant(engine) {\n    if (engine === false) {\n        return;\n    }\n    else if (typeof engine === 'object' && engine.schemaTag) {\n        return engine.schemaTag;\n    }\n    else {\n        return process.env.ENGINE_SCHEMA_TAG;\n    }\n}\nfunction getEngineServiceId(engine) {\n    const engineApiKey = getEngineApiKey(engine);\n    if (engineApiKey) {\n        return engineApiKey.split(':', 2)[1];\n    }\n    return;\n}\nconst forbidUploadsForTesting = process && process.env.NODE_ENV === 'test' && !runtimeSupportsUploads_1.default;\nfunction approximateObjectSize(obj) {\n    return Buffer.byteLength(JSON.stringify(obj), 'utf8');\n}\nclass ApolloServerBase {\n    constructor(config) {\n        this.graphqlPath = '/graphql';\n        this.requestOptions = Object.create(null);\n        this.plugins = [];\n        this.toDispose = new Set();\n        if (!config)\n            throw new Error('ApolloServer requires options.');\n        this.config = config;\n        const { context, resolvers, schema, schemaDirectives, modules, typeDefs, parseOptions = {}, introspection, mocks, mockEntireSchema, extensions, engine, subscriptions, uploads, playground, plugins, gateway, experimental_approximateDocumentStoreMiB } = config, requestOptions = __rest(config, [\"context\", \"resolvers\", \"schema\", \"schemaDirectives\", \"modules\", \"typeDefs\", \"parseOptions\", \"introspection\", \"mocks\", \"mockEntireSchema\", \"extensions\", \"engine\", \"subscriptions\", \"uploads\", \"playground\", \"plugins\", \"gateway\", \"experimental_approximateDocumentStoreMiB\"]);\n        if (gateway && (modules || schema || typeDefs || resolvers)) {\n            throw new Error('Cannot define both `gateway` and any of: `modules`, `schema`, `typeDefs`, or `resolvers`');\n        }\n        this.parseOptions = parseOptions;\n        this.context = context;\n        this.ensurePluginInstantiation(plugins);\n        const isDev = process.env.NODE_ENV !== 'production';\n        if ((typeof introspection === 'boolean' && !introspection) ||\n            (introspection === undefined && !isDev)) {\n            const noIntro = [NoIntrospection];\n            requestOptions.validationRules = requestOptions.validationRules\n                ? requestOptions.validationRules.concat(noIntro)\n                : noIntro;\n        }\n        if (requestOptions.cacheControl !== false) {\n            if (typeof requestOptions.cacheControl === 'boolean' &&\n                requestOptions.cacheControl === true) {\n                requestOptions.cacheControl = {\n                    stripFormattedExtensions: false,\n                    calculateHttpHeaders: false,\n                    defaultMaxAge: 0,\n                };\n            }\n            else {\n                requestOptions.cacheControl = Object.assign({ stripFormattedExtensions: true, calculateHttpHeaders: true, defaultMaxAge: 0 }, requestOptions.cacheControl);\n            }\n        }\n        if (!requestOptions.cache) {\n            requestOptions.cache = new apollo_server_caching_1.InMemoryLRUCache();\n        }\n        if (requestOptions.persistedQueries !== false) {\n            const _a = requestOptions.persistedQueries || Object.create(null), { cache: apqCache = requestOptions.cache } = _a, apqOtherOptions = __rest(_a, [\"cache\"]);\n            requestOptions.persistedQueries = Object.assign({ cache: new apollo_server_caching_1.PrefixingKeyValueCache(apqCache, requestPipeline_1.APQ_CACHE_PREFIX) }, apqOtherOptions);\n        }\n        else {\n            delete requestOptions.persistedQueries;\n        }\n        this.requestOptions = requestOptions;\n        if (uploads !== false && !forbidUploadsForTesting) {\n            if (this.supportsUploads()) {\n                if (!runtimeSupportsUploads_1.default) {\n                    printNodeFileUploadsMessage();\n                    throw new Error('`graphql-upload` is no longer supported on Node.js < v8.5.0.  ' +\n                        'See https://bit.ly/gql-upload-node-6.');\n                }\n                if (uploads === true || typeof uploads === 'undefined') {\n                    this.uploadsConfig = {};\n                }\n                else {\n                    this.uploadsConfig = uploads;\n                }\n            }\n            else if (uploads) {\n                throw new Error('This implementation of ApolloServer does not support file uploads because the environment cannot accept multi-part forms');\n            }\n        }\n        if (engine && typeof engine === 'object') {\n            if (engine.maskErrorDetails && engine.rewriteError) {\n                throw new Error(\"Can't set both maskErrorDetails and rewriteError!\");\n            }\n            else if (engine.rewriteError &&\n                typeof engine.rewriteError !== 'function') {\n                throw new Error('rewriteError must be a function');\n            }\n            else if (engine.maskErrorDetails) {\n                engine.rewriteError = () => new graphql_1.GraphQLError('<masked>');\n                delete engine.maskErrorDetails;\n            }\n        }\n        this.engineServiceId = getEngineServiceId(engine);\n        const apiKey = getEngineApiKey(engine);\n        if (apiKey) {\n            this.engineApiKeyHash = createSHA_1.default('sha512')\n                .update(apiKey)\n                .digest('hex');\n        }\n        if (this.engineServiceId) {\n            const { EngineReportingAgent } = require('apollo-engine-reporting');\n            this.engineReportingAgent = new EngineReportingAgent(typeof engine === 'object' ? engine : Object.create(null));\n        }\n        if (gateway && subscriptions !== false) {\n            throw new Error([\n                'Subscriptions are not yet compatible with the gateway.',\n                \"Set `subscriptions: false` in Apollo Server's constructor to\",\n                'explicitly disable subscriptions (which are on by default)',\n                'and allow for gateway functionality.',\n            ].join(' '));\n        }\n        else if (subscriptions !== false) {\n            if (this.supportsSubscriptions()) {\n                if (subscriptions === true || typeof subscriptions === 'undefined') {\n                    this.subscriptionServerOptions = {\n                        path: this.graphqlPath,\n                    };\n                }\n                else if (typeof subscriptions === 'string') {\n                    this.subscriptionServerOptions = { path: subscriptions };\n                }\n                else {\n                    this.subscriptionServerOptions = Object.assign({ path: this.graphqlPath }, subscriptions);\n                }\n                this.subscriptionsPath = this.subscriptionServerOptions.path;\n            }\n            else if (subscriptions) {\n                throw new Error('This implementation of ApolloServer does not support GraphQL subscriptions.');\n            }\n        }\n        this.playgroundOptions = playground_1.createPlaygroundOptions(playground);\n        const _schema = this.initSchema();\n        if (graphql_1.isSchema(_schema)) {\n            const derivedData = this.generateSchemaDerivedData(_schema);\n            this.schema = derivedData.schema;\n            this.schemaDerivedData = Promise.resolve(derivedData);\n        }\n        else if (typeof _schema.then === 'function') {\n            this.schemaDerivedData = _schema.then(schema => this.generateSchemaDerivedData(schema));\n        }\n        else {\n            throw new Error(\"Unexpected error: Unable to resolve a valid GraphQLSchema.  Please file an issue with a reproduction of this error, if possible.\");\n        }\n    }\n    setGraphQLPath(path) {\n        this.graphqlPath = path;\n    }\n    initSchema() {\n        const { gateway, engine, schema, modules, typeDefs, resolvers, schemaDirectives, parseOptions, } = this.config;\n        if (gateway) {\n            this.toDispose.add(gateway.onSchemaChange(schema => (this.schemaDerivedData = Promise.resolve(this.generateSchemaDerivedData(schema)))));\n            const graphVariant = getEngineGraphVariant(engine);\n            const engineConfig = this.engineApiKeyHash && this.engineServiceId\n                ? Object.assign({ apiKeyHash: this.engineApiKeyHash, graphId: this.engineServiceId }, (graphVariant && { graphVariant })) : undefined;\n            return gateway.load({ engine: engineConfig }).then(config => {\n                this.requestOptions.executor = config.executor;\n                return config.schema;\n            });\n        }\n        let constructedSchema;\n        if (schema) {\n            constructedSchema = schema;\n        }\n        else if (modules) {\n            const { schema, errors } = apollo_tools_1.buildServiceDefinition(modules);\n            if (errors && errors.length > 0) {\n                throw new Error(errors.map(error => error.message).join('\\n\\n'));\n            }\n            constructedSchema = schema;\n        }\n        else {\n            if (!typeDefs) {\n                throw Error('Apollo Server requires either an existing schema, modules or typeDefs');\n            }\n            const augmentedTypeDefs = Array.isArray(typeDefs) ? typeDefs : [typeDefs];\n            if (!isDirectiveDefined_1.isDirectiveDefined(augmentedTypeDefs, 'cacheControl')) {\n                augmentedTypeDefs.push(index_1.gql `\n            enum CacheControlScope {\n              PUBLIC\n              PRIVATE\n            }\n\n            directive @cacheControl(\n              maxAge: Int\n              scope: CacheControlScope\n            ) on FIELD_DEFINITION | OBJECT | INTERFACE\n          `);\n            }\n            if (this.uploadsConfig) {\n                const { GraphQLUpload } = require('graphql-upload');\n                if (Array.isArray(resolvers)) {\n                    if (resolvers.every(resolver => !resolver.Upload)) {\n                        resolvers.push({ Upload: GraphQLUpload });\n                    }\n                }\n                else {\n                    if (resolvers && !resolvers.Upload) {\n                        resolvers.Upload = GraphQLUpload;\n                    }\n                }\n                augmentedTypeDefs.push(index_1.gql `\n            scalar Upload\n          `);\n            }\n            constructedSchema = graphql_tools_1.makeExecutableSchema({\n                typeDefs: augmentedTypeDefs,\n                schemaDirectives,\n                resolvers,\n                parseOptions,\n            });\n        }\n        return constructedSchema;\n    }\n    generateSchemaDerivedData(schema) {\n        const schemaHash = schemaHash_1.generateSchemaHash(schema);\n        const { mocks, mockEntireSchema, extensions: _extensions } = this.config;\n        if (mocks || (typeof mockEntireSchema !== 'undefined' && mocks !== false)) {\n            graphql_tools_1.addMockFunctionsToSchema({\n                schema,\n                mocks: typeof mocks === 'boolean' || typeof mocks === 'undefined'\n                    ? {}\n                    : mocks,\n                preserveResolvers: typeof mockEntireSchema === 'undefined' ? false : !mockEntireSchema,\n            });\n        }\n        const extensions = [];\n        const schemaIsFederated = this.schemaIsFederated(schema);\n        const { engine } = this.config;\n        if (this.engineReportingAgent) {\n            if (schemaIsFederated) {\n                console.warn(\"It looks like you're running a federated schema and you've configured your service \" +\n                    'to report metrics to Apollo Graph Manager. You should only configure your Apollo gateway ' +\n                    'to report metrics to Apollo Graph Manager.');\n            }\n            extensions.push(() => this.engineReportingAgent.newExtension(schemaHash));\n        }\n        else if (engine !== false && schemaIsFederated) {\n            const { EngineFederatedTracingExtension, } = require('apollo-engine-reporting');\n            const rewriteError = engine && typeof engine === 'object' ? engine.rewriteError : undefined;\n            extensions.push(() => new EngineFederatedTracingExtension({ rewriteError }));\n        }\n        extensions.push(...(_extensions || []));\n        const documentStore = this.initializeDocumentStore();\n        return {\n            schema,\n            schemaHash,\n            extensions,\n            documentStore,\n        };\n    }\n    willStart() {\n        var _a;\n        return __awaiter(this, void 0, void 0, function* () {\n            const { schema, schemaHash } = yield this.schemaDerivedData;\n            const service = {\n                schema: schema,\n                schemaHash: schemaHash,\n                engine: {\n                    serviceID: this.engineServiceId,\n                    apiKeyHash: this.engineApiKeyHash,\n                },\n            };\n            if ((_a = this.requestOptions.persistedQueries) === null || _a === void 0 ? void 0 : _a.cache) {\n                service.persistedQueries = {\n                    cache: this.requestOptions.persistedQueries.cache,\n                };\n            }\n            persistedQueries: this.requestOptions.persistedQueries,\n                yield Promise.all(this.plugins.map(plugin => plugin.serverWillStart &&\n                    plugin.serverWillStart(service)));\n        });\n    }\n    stop() {\n        return __awaiter(this, void 0, void 0, function* () {\n            this.toDispose.forEach(dispose => dispose());\n            if (this.subscriptionServer)\n                yield this.subscriptionServer.close();\n            if (this.engineReportingAgent) {\n                this.engineReportingAgent.stop();\n                yield this.engineReportingAgent.sendAllReports();\n            }\n        });\n    }\n    installSubscriptionHandlers(server) {\n        if (!this.subscriptionServerOptions) {\n            if (this.config.gateway) {\n                throw Error('Subscriptions are not supported when operating as a gateway');\n            }\n            if (this.supportsSubscriptions()) {\n                throw Error('Subscriptions are disabled, due to subscriptions set to false in the ApolloServer constructor');\n            }\n            else {\n                throw Error('Subscriptions are not supported, choose an integration, such as apollo-server-express that allows persistent connections');\n            }\n        }\n        const { SubscriptionServer } = require('subscriptions-transport-ws');\n        const { onDisconnect, onConnect, keepAlive, path, } = this.subscriptionServerOptions;\n        const schema = this.schema;\n        if (this.schema === undefined)\n            throw new Error('Schema undefined during creation of subscription server.');\n        this.subscriptionServer = SubscriptionServer.create({\n            schema,\n            execute: graphql_1.execute,\n            subscribe: graphql_1.subscribe,\n            onConnect: onConnect\n                ? onConnect\n                : (connectionParams) => (Object.assign({}, connectionParams)),\n            onDisconnect: onDisconnect,\n            onOperation: (message, connection) => __awaiter(this, void 0, void 0, function* () {\n                connection.formatResponse = (value) => (Object.assign(Object.assign({}, value), { errors: value.errors &&\n                        apollo_server_errors_1.formatApolloErrors([...value.errors], {\n                            formatter: this.requestOptions.formatError,\n                            debug: this.requestOptions.debug,\n                        }) }));\n                connection.formatError = this.requestOptions.formatError;\n                let context = this.context ? this.context : { connection };\n                try {\n                    context =\n                        typeof this.context === 'function'\n                            ? yield this.context({ connection, payload: message.payload })\n                            : context;\n                }\n                catch (e) {\n                    throw apollo_server_errors_1.formatApolloErrors([e], {\n                        formatter: this.requestOptions.formatError,\n                        debug: this.requestOptions.debug,\n                    })[0];\n                }\n                return Object.assign(Object.assign({}, connection), { context });\n            }),\n            keepAlive,\n        }, {\n            server,\n            path,\n        });\n    }\n    supportsSubscriptions() {\n        return false;\n    }\n    supportsUploads() {\n        return false;\n    }\n    schemaIsFederated(schema) {\n        const serviceType = schema.getType('_Service');\n        if (!(serviceType && graphql_1.isObjectType(serviceType))) {\n            return false;\n        }\n        const sdlField = serviceType.getFields().sdl;\n        if (!sdlField) {\n            return false;\n        }\n        const sdlFieldType = sdlField.type;\n        if (!graphql_1.isScalarType(sdlFieldType)) {\n            return false;\n        }\n        return sdlFieldType.name == 'String';\n    }\n    ensurePluginInstantiation(plugins) {\n        if (!plugins || !plugins.length) {\n            return;\n        }\n        this.plugins = plugins.map(plugin => {\n            if (typeof plugin === 'function') {\n                return plugin();\n            }\n            return plugin;\n        });\n    }\n    initializeDocumentStore() {\n        return new apollo_server_caching_1.InMemoryLRUCache({\n            maxSize: Math.pow(2, 20) *\n                (this.experimental_approximateDocumentStoreMiB || 30),\n            sizeCalculator: approximateObjectSize,\n        });\n    }\n    graphQLServerOptions(integrationContextArgument) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const { schema, documentStore, extensions } = yield this.schemaDerivedData;\n            let context = this.context ? this.context : {};\n            try {\n                context =\n                    typeof this.context === 'function'\n                        ? yield this.context(integrationContextArgument || {})\n                        : context;\n            }\n            catch (error) {\n                context = () => {\n                    throw error;\n                };\n            }\n            return Object.assign({ schema, plugins: this.plugins, documentStore,\n                extensions,\n                context, persistedQueries: this.requestOptions\n                    .persistedQueries, fieldResolver: this.requestOptions.fieldResolver, parseOptions: this.parseOptions, reporting: !!this.engineReportingAgent }, this.requestOptions);\n        });\n    }\n    executeOperation(request) {\n        return __awaiter(this, void 0, void 0, function* () {\n            let options;\n            try {\n                options = yield this.graphQLServerOptions();\n            }\n            catch (e) {\n                e.message = `Invalid options provided to ApolloServer: ${e.message}`;\n                throw new Error(e);\n            }\n            if (typeof options.context === 'function') {\n                options.context = options.context();\n            }\n            const requestCtx = {\n                request,\n                context: options.context || Object.create(null),\n                cache: options.cache,\n                response: {\n                    http: {\n                        headers: new apollo_server_env_1.Headers(),\n                    },\n                },\n            };\n            return requestPipeline_1.processGraphQLRequest(options, requestCtx);\n        });\n    }\n}\nexports.ApolloServerBase = ApolloServerBase;\nfunction printNodeFileUploadsMessage() {\n    console.error([\n        '*****************************************************************',\n        '*                                                               *',\n        '* ERROR! Manual intervention is necessary for Node.js < v8.5.0! *',\n        '*                                                               *',\n        '*****************************************************************',\n        '',\n        'The third-party `graphql-upload` package, which is used to implement',\n        'file uploads in Apollo Server 2.x, no longer supports Node.js LTS',\n        'versions prior to Node.js v8.5.0.',\n        '',\n        'Deployments which NEED file upload capabilities should update to',\n        'Node.js >= v8.5.0 to continue using uploads.',\n        '',\n        'If this server DOES NOT NEED file uploads and wishes to continue',\n        'using this version of Node.js, uploads can be disabled by adding:',\n        '',\n        '  uploads: false,',\n        '',\n        '...to the options for Apollo Server and re-deploying the server.',\n        '',\n        'For more information, see https://bit.ly/gql-upload-node-6.',\n        '',\n    ].join('\\n'));\n}\n//# sourceMappingURL=ApolloServer.js.map"]},"metadata":{},"sourceType":"script"}