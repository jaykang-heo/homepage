{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst graphql_1 = require(\"graphql\");\n\nvar CacheScope;\n\n(function (CacheScope) {\n  CacheScope[\"Public\"] = \"PUBLIC\";\n  CacheScope[\"Private\"] = \"PRIVATE\";\n})(CacheScope = exports.CacheScope || (exports.CacheScope = {}));\n\nclass CacheControlExtension {\n  constructor(options = {}) {\n    this.options = options;\n    this.hints = new Map();\n    this.defaultMaxAge = options.defaultMaxAge || 0;\n  }\n\n  willResolveField(_source, _args, _context, info) {\n    let hint = {};\n    const targetType = graphql_1.getNamedType(info.returnType);\n\n    if (targetType instanceof graphql_1.GraphQLObjectType || targetType instanceof graphql_1.GraphQLInterfaceType) {\n      if (targetType.astNode) {\n        hint = mergeHints(hint, cacheHintFromDirectives(targetType.astNode.directives));\n      }\n    }\n\n    const fieldDef = info.parentType.getFields()[info.fieldName];\n\n    if (fieldDef.astNode) {\n      hint = mergeHints(hint, cacheHintFromDirectives(fieldDef.astNode.directives));\n    }\n\n    if ((targetType instanceof graphql_1.GraphQLObjectType || targetType instanceof graphql_1.GraphQLInterfaceType || !info.path.prev) && hint.maxAge === undefined) {\n      hint.maxAge = this.defaultMaxAge;\n    }\n\n    if (hint.maxAge !== undefined || hint.scope !== undefined) {\n      this.addHint(info.path, hint);\n    }\n\n    info.cacheControl = {\n      setCacheHint: hint => {\n        this.addHint(info.path, hint);\n      },\n      cacheHint: hint\n    };\n  }\n\n  addHint(path, hint) {\n    const existingCacheHint = this.hints.get(path);\n\n    if (existingCacheHint) {\n      this.hints.set(path, mergeHints(existingCacheHint, hint));\n    } else {\n      this.hints.set(path, hint);\n    }\n  }\n\n  format() {\n    if (this.options.stripFormattedExtensions !== false) return;\n    return ['cacheControl', {\n      version: 1,\n      hints: Array.from(this.hints).map(([path, hint]) => Object.assign({\n        path: [...graphql_1.responsePathAsArray(path)]\n      }, hint))\n    }];\n  }\n\n  willSendResponse(o) {\n    if (!this.options.calculateHttpHeaders || !o.graphqlResponse.http || o.graphqlResponse.errors) {\n      return;\n    }\n\n    const overallCachePolicy = this.computeOverallCachePolicy();\n\n    if (overallCachePolicy) {\n      o.graphqlResponse.http.headers.set('Cache-Control', `max-age=${overallCachePolicy.maxAge}, ${overallCachePolicy.scope.toLowerCase()}`);\n    }\n  }\n\n  overrideOverallCachePolicy(overallCachePolicy) {\n    this.overallCachePolicyOverride = overallCachePolicy;\n  }\n\n  computeOverallCachePolicy() {\n    if (this.overallCachePolicyOverride) {\n      return this.overallCachePolicyOverride;\n    }\n\n    let lowestMaxAge = undefined;\n    let scope = CacheScope.Public;\n\n    for (const hint of this.hints.values()) {\n      if (hint.maxAge !== undefined) {\n        lowestMaxAge = lowestMaxAge !== undefined ? Math.min(lowestMaxAge, hint.maxAge) : hint.maxAge;\n      }\n\n      if (hint.scope === CacheScope.Private) {\n        scope = CacheScope.Private;\n      }\n    }\n\n    return lowestMaxAge ? {\n      maxAge: lowestMaxAge,\n      scope\n    } : undefined;\n  }\n\n}\n\nexports.CacheControlExtension = CacheControlExtension;\n\nfunction cacheHintFromDirectives(directives) {\n  if (!directives) return undefined;\n  const cacheControlDirective = directives.find(directive => directive.name.value === 'cacheControl');\n  if (!cacheControlDirective) return undefined;\n  if (!cacheControlDirective.arguments) return undefined;\n  const maxAgeArgument = cacheControlDirective.arguments.find(argument => argument.name.value === 'maxAge');\n  const scopeArgument = cacheControlDirective.arguments.find(argument => argument.name.value === 'scope');\n  return {\n    maxAge: maxAgeArgument && maxAgeArgument.value && maxAgeArgument.value.kind === 'IntValue' ? parseInt(maxAgeArgument.value.value) : undefined,\n    scope: scopeArgument && scopeArgument.value && scopeArgument.value.kind === 'EnumValue' ? scopeArgument.value.value : undefined\n  };\n}\n\nfunction mergeHints(hint, otherHint) {\n  if (!otherHint) return hint;\n  return {\n    maxAge: otherHint.maxAge !== undefined ? otherHint.maxAge : hint.maxAge,\n    scope: otherHint.scope || hint.scope\n  };\n}","map":{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst graphql_1 = require(\"graphql\");\nvar CacheScope;\n(function (CacheScope) {\n    CacheScope[\"Public\"] = \"PUBLIC\";\n    CacheScope[\"Private\"] = \"PRIVATE\";\n})(CacheScope = exports.CacheScope || (exports.CacheScope = {}));\nclass CacheControlExtension {\n    constructor(options = {}) {\n        this.options = options;\n        this.hints = new Map();\n        this.defaultMaxAge = options.defaultMaxAge || 0;\n    }\n    willResolveField(_source, _args, _context, info) {\n        let hint = {};\n        const targetType = graphql_1.getNamedType(info.returnType);\n        if (targetType instanceof graphql_1.GraphQLObjectType ||\n            targetType instanceof graphql_1.GraphQLInterfaceType) {\n            if (targetType.astNode) {\n                hint = mergeHints(hint, cacheHintFromDirectives(targetType.astNode.directives));\n            }\n        }\n        const fieldDef = info.parentType.getFields()[info.fieldName];\n        if (fieldDef.astNode) {\n            hint = mergeHints(hint, cacheHintFromDirectives(fieldDef.astNode.directives));\n        }\n        if ((targetType instanceof graphql_1.GraphQLObjectType ||\n            targetType instanceof graphql_1.GraphQLInterfaceType ||\n            !info.path.prev) &&\n            hint.maxAge === undefined) {\n            hint.maxAge = this.defaultMaxAge;\n        }\n        if (hint.maxAge !== undefined || hint.scope !== undefined) {\n            this.addHint(info.path, hint);\n        }\n        info.cacheControl = {\n            setCacheHint: (hint) => {\n                this.addHint(info.path, hint);\n            },\n            cacheHint: hint,\n        };\n    }\n    addHint(path, hint) {\n        const existingCacheHint = this.hints.get(path);\n        if (existingCacheHint) {\n            this.hints.set(path, mergeHints(existingCacheHint, hint));\n        }\n        else {\n            this.hints.set(path, hint);\n        }\n    }\n    format() {\n        if (this.options.stripFormattedExtensions !== false)\n            return;\n        return [\n            'cacheControl',\n            {\n                version: 1,\n                hints: Array.from(this.hints).map(([path, hint]) => (Object.assign({ path: [...graphql_1.responsePathAsArray(path)] }, hint))),\n            },\n        ];\n    }\n    willSendResponse(o) {\n        if (!this.options.calculateHttpHeaders ||\n            !o.graphqlResponse.http ||\n            o.graphqlResponse.errors) {\n            return;\n        }\n        const overallCachePolicy = this.computeOverallCachePolicy();\n        if (overallCachePolicy) {\n            o.graphqlResponse.http.headers.set('Cache-Control', `max-age=${overallCachePolicy.maxAge}, ${overallCachePolicy.scope.toLowerCase()}`);\n        }\n    }\n    overrideOverallCachePolicy(overallCachePolicy) {\n        this.overallCachePolicyOverride = overallCachePolicy;\n    }\n    computeOverallCachePolicy() {\n        if (this.overallCachePolicyOverride) {\n            return this.overallCachePolicyOverride;\n        }\n        let lowestMaxAge = undefined;\n        let scope = CacheScope.Public;\n        for (const hint of this.hints.values()) {\n            if (hint.maxAge !== undefined) {\n                lowestMaxAge =\n                    lowestMaxAge !== undefined\n                        ? Math.min(lowestMaxAge, hint.maxAge)\n                        : hint.maxAge;\n            }\n            if (hint.scope === CacheScope.Private) {\n                scope = CacheScope.Private;\n            }\n        }\n        return lowestMaxAge\n            ? {\n                maxAge: lowestMaxAge,\n                scope,\n            }\n            : undefined;\n    }\n}\nexports.CacheControlExtension = CacheControlExtension;\nfunction cacheHintFromDirectives(directives) {\n    if (!directives)\n        return undefined;\n    const cacheControlDirective = directives.find(directive => directive.name.value === 'cacheControl');\n    if (!cacheControlDirective)\n        return undefined;\n    if (!cacheControlDirective.arguments)\n        return undefined;\n    const maxAgeArgument = cacheControlDirective.arguments.find(argument => argument.name.value === 'maxAge');\n    const scopeArgument = cacheControlDirective.arguments.find(argument => argument.name.value === 'scope');\n    return {\n        maxAge: maxAgeArgument &&\n            maxAgeArgument.value &&\n            maxAgeArgument.value.kind === 'IntValue'\n            ? parseInt(maxAgeArgument.value.value)\n            : undefined,\n        scope: scopeArgument &&\n            scopeArgument.value &&\n            scopeArgument.value.kind === 'EnumValue'\n            ? scopeArgument.value.value\n            : undefined,\n    };\n}\nfunction mergeHints(hint, otherHint) {\n    if (!otherHint)\n        return hint;\n    return {\n        maxAge: otherHint.maxAge !== undefined ? otherHint.maxAge : hint.maxAge,\n        scope: otherHint.scope || hint.scope,\n    };\n}\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"script"}